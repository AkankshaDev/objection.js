<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Query examples | Objection.js</title>
    <meta name="description" content="An SQL friendly ORM for node.js">
    
    
    <link rel="preload" href="/objection.js/assets/css/0.styles.887cf860.css" as="style"><link rel="preload" href="/objection.js/assets/js/app.3297ac94.js" as="script"><link rel="preload" href="/objection.js/assets/js/27.5a15c74a.js" as="script"><link rel="prefetch" href="/objection.js/assets/js/1.1300c266.js"><link rel="prefetch" href="/objection.js/assets/js/10.239be4a3.js"><link rel="prefetch" href="/objection.js/assets/js/11.7a51e2ad.js"><link rel="prefetch" href="/objection.js/assets/js/12.e611bd5c.js"><link rel="prefetch" href="/objection.js/assets/js/13.eb93f29d.js"><link rel="prefetch" href="/objection.js/assets/js/14.6aca307d.js"><link rel="prefetch" href="/objection.js/assets/js/15.b77632cb.js"><link rel="prefetch" href="/objection.js/assets/js/16.715b52f5.js"><link rel="prefetch" href="/objection.js/assets/js/17.7b452395.js"><link rel="prefetch" href="/objection.js/assets/js/18.7dc67811.js"><link rel="prefetch" href="/objection.js/assets/js/19.7467d510.js"><link rel="prefetch" href="/objection.js/assets/js/2.b3112ac3.js"><link rel="prefetch" href="/objection.js/assets/js/20.abce9fb3.js"><link rel="prefetch" href="/objection.js/assets/js/21.bbef3375.js"><link rel="prefetch" href="/objection.js/assets/js/22.6506f0fb.js"><link rel="prefetch" href="/objection.js/assets/js/23.84d018d4.js"><link rel="prefetch" href="/objection.js/assets/js/24.ca239af0.js"><link rel="prefetch" href="/objection.js/assets/js/25.7f3b0cd6.js"><link rel="prefetch" href="/objection.js/assets/js/26.250f021f.js"><link rel="prefetch" href="/objection.js/assets/js/28.51c3c69b.js"><link rel="prefetch" href="/objection.js/assets/js/29.18df49fe.js"><link rel="prefetch" href="/objection.js/assets/js/3.4f09a0a6.js"><link rel="prefetch" href="/objection.js/assets/js/30.d15fd35b.js"><link rel="prefetch" href="/objection.js/assets/js/31.145a53a9.js"><link rel="prefetch" href="/objection.js/assets/js/32.8c6dbc57.js"><link rel="prefetch" href="/objection.js/assets/js/33.7659df30.js"><link rel="prefetch" href="/objection.js/assets/js/34.cfd603c8.js"><link rel="prefetch" href="/objection.js/assets/js/35.816cbd36.js"><link rel="prefetch" href="/objection.js/assets/js/36.fc3faeb5.js"><link rel="prefetch" href="/objection.js/assets/js/37.135dcaf6.js"><link rel="prefetch" href="/objection.js/assets/js/38.403e6b1f.js"><link rel="prefetch" href="/objection.js/assets/js/39.b63783a5.js"><link rel="prefetch" href="/objection.js/assets/js/40.f817eff1.js"><link rel="prefetch" href="/objection.js/assets/js/41.f6b40db3.js"><link rel="prefetch" href="/objection.js/assets/js/42.eb19c2cc.js"><link rel="prefetch" href="/objection.js/assets/js/43.26c754e9.js"><link rel="prefetch" href="/objection.js/assets/js/44.0fab487d.js"><link rel="prefetch" href="/objection.js/assets/js/45.2a93abb8.js"><link rel="prefetch" href="/objection.js/assets/js/46.0cc90e43.js"><link rel="prefetch" href="/objection.js/assets/js/47.255ee1f6.js"><link rel="prefetch" href="/objection.js/assets/js/48.02e85389.js"><link rel="prefetch" href="/objection.js/assets/js/49.387bd187.js"><link rel="prefetch" href="/objection.js/assets/js/6.1f2cd6a7.js"><link rel="prefetch" href="/objection.js/assets/js/7.20cecf4f.js"><link rel="prefetch" href="/objection.js/assets/js/8.83363aa3.js"><link rel="prefetch" href="/objection.js/assets/js/9.d651b3b8.js"><link rel="prefetch" href="/objection.js/assets/js/vendors~docsearch.22f43628.js">
    <link rel="stylesheet" href="/objection.js/assets/css/0.styles.887cf860.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/objection.js/" class="home-link router-link-active"><!----> <span class="site-name">Objection.js</span></a> <div class="links" style="max-width:nullpx;"><form id="search-form" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/objection.js/guide/" class="nav-link router-link-active">Guide</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">API Reference</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/objection.js/api/objection/" class="nav-link">Main Module</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/query-builder/" class="nav-link">Query Builder</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/model/" class="nav-link">Model</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/types/" class="nav-link">Types</a></li></ul></div></div><div class="nav-item"><a href="/objection.js/recipes/" class="nav-link">Recipe Book</a></div><div class="nav-item"><a href="/objection.js/changelog/" class="nav-link">Changelog</a></div> <a href="https://github.com/vincit/objection.js" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/objection.js/guide/" class="nav-link router-link-active">Guide</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">API Reference</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/objection.js/api/objection/" class="nav-link">Main Module</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/query-builder/" class="nav-link">Query Builder</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/model/" class="nav-link">Model</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/types/" class="nav-link">Types</a></li></ul></div></div><div class="nav-item"><a href="/objection.js/recipes/" class="nav-link">Recipe Book</a></div><div class="nav-item"><a href="/objection.js/changelog/" class="nav-link">Changelog</a></div> <a href="https://github.com/vincit/objection.js" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>Guide</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/objection.js/guide/installation.html" class="sidebar-link">Installation</a></li><li><a href="/objection.js/guide/getting-started.html" class="sidebar-link">Getting started</a></li><li><a href="/objection.js/guide/models.html" class="sidebar-link">Models</a></li><li><a href="/objection.js/guide/relations.html" class="sidebar-link">Relations</a></li><li><a href="/objection.js/guide/query-examples.html" class="active sidebar-link">Query examples</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/objection.js/guide/query-examples.html#basic-queries" class="sidebar-link">Basic queries</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/objection.js/guide/query-examples.html#find-queries" class="sidebar-link">Find queries</a></li><li class="sidebar-sub-header"><a href="/objection.js/guide/query-examples.html#insert-queries" class="sidebar-link">Insert queries</a></li><li class="sidebar-sub-header"><a href="/objection.js/guide/query-examples.html#update-queries" class="sidebar-link">Update queries</a></li><li class="sidebar-sub-header"><a href="/objection.js/guide/query-examples.html#delete-queries" class="sidebar-link">Delete queries</a></li></ul></li><li class="sidebar-sub-header"><a href="/objection.js/guide/query-examples.html#relation-queries" class="sidebar-link">Relation queries</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/objection.js/guide/query-examples.html#find-queries-2" class="sidebar-link">Find queries</a></li><li class="sidebar-sub-header"><a href="/objection.js/guide/query-examples.html#insert-queries-2" class="sidebar-link">Insert queries</a></li><li class="sidebar-sub-header"><a href="/objection.js/guide/query-examples.html#update-queries-2" class="sidebar-link">Update queries</a></li><li class="sidebar-sub-header"><a href="/objection.js/guide/query-examples.html#delete-queries-2" class="sidebar-link">Delete queries</a></li><li class="sidebar-sub-header"><a href="/objection.js/guide/query-examples.html#relate-queries" class="sidebar-link">Relate queries</a></li><li class="sidebar-sub-header"><a href="/objection.js/guide/query-examples.html#unrelate-queries" class="sidebar-link">Unrelate queries</a></li></ul></li><li class="sidebar-sub-header"><a href="/objection.js/guide/query-examples.html#eager-loading" class="sidebar-link">Eager loading</a></li><li class="sidebar-sub-header"><a href="/objection.js/guide/query-examples.html#graph-inserts" class="sidebar-link">Graph inserts</a></li><li class="sidebar-sub-header"><a href="/objection.js/guide/query-examples.html#graph-upserts" class="sidebar-link">Graph upserts</a></li></ul></li><li><a href="/objection.js/guide/transactions.html" class="sidebar-link">Transactions</a></li><li><a href="/objection.js/guide/validation.html" class="sidebar-link">Validation</a></li><li><a href="/objection.js/guide/documents.html" class="sidebar-link">Documents</a></li><li><a href="/objection.js/guide/plugins.html" class="sidebar-link">Plugins</a></li><li><a href="/objection.js/guide/contributing.html" class="sidebar-link">Contribution guide</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="query-examples"><a href="#query-examples" aria-hidden="true" class="header-anchor">#</a> Query examples</h1> <p>The <code>Person</code> model used in the examples is defined <a href="/objection.js/guide/models.html#examples">here</a>.</p> <p>All queries are started with one of the <a href="/objection.js/api/model/">Model</a> methods <a href="/objection.js/api/model/static-methods.html#static-query">query</a>, <a href="/objection.js/api/model/instance-methods.html#query">$query</a> or <a href="/objection.js/api/model/instance-methods.html#relatedquery">$relatedQuery</a>. All these methods return a <a href="/objection.js/api/query-builder/">QueryBuilder</a> instance that can be used just like a <a href="http://knexjs.org/#Builder" target="_blank" rel="noopener noreferrer">knex QueryBuilder<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> but they also have a bunch of methods added by objection.</p> <h2 id="basic-queries"><a href="#basic-queries" aria-hidden="true" class="header-anchor">#</a> Basic queries</h2> <h3 id="find-queries"><a href="#find-queries" aria-hidden="true" class="header-anchor">#</a> Find queries</h3> <p>Find queries can be created by calling <a href="/objection.js/api/model/static-methods.html#static-query">Model.query()</a> and chaining query builder methods for the returned
<a href="/objection.js/api/query-builder/">QueryBuilder</a> instance.</p> <p>In addition to the examples here, you can find more examples behind these links.</p> <ul><li><a href="/objection.js/recipes/subqueries.html">subqueries</a></li> <li><a href="/objection.js/recipes/raw-queries.html">raw queries</a></li></ul> <p>There's also a large amount of examples in the <a href="/objection.js/api/query-builder/">API documentation</a>.</p> <h5 id="examples"><a href="#examples" aria-hidden="true" class="header-anchor">#</a> Examples</h5> <p>Fetch all people from the database:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> people <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">instanceof</span> <span class="token class-name">Person</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// --&gt; true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'there are'</span><span class="token punctuation">,</span> people<span class="token punctuation">.</span>length<span class="token punctuation">,</span> <span class="token string">'People in total'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token string">&quot;people&quot;</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&quot;people&quot;</span>
</code></pre></div><p>The return value of the <a href="/objection.js/api/model/static-methods.html#static-query">query</a> method is an instance of <a href="/objection.js/api/query-builder/">QueryBuilder</a> that has all the methods a <a href="http://knexjs.org/#Builder" target="_blank" rel="noopener noreferrer">knex QueryBuilder<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> has and a lot more. Here is a simple example that uses some of them:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> middleAgedJennifers <span class="token operator">=</span> <span class="token keyword">await</span> Person
  <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token string">'&gt;'</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token string">'&lt;'</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'firstName'</span><span class="token punctuation">,</span> <span class="token string">'Jennifer'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">'lastName'</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'The last name of the first middle aged Jennifer is'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>middleAgedJennifers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lastName<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token string">&quot;persons&quot;</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&quot;persons&quot;</span>
<span class="token keyword">where</span> <span class="token string">&quot;age&quot;</span> <span class="token operator">&gt;</span> <span class="token number">40</span>
<span class="token operator">and</span> <span class="token string">&quot;age&quot;</span> <span class="token operator">&lt;</span> <span class="token number">60</span>
<span class="token operator">and</span> <span class="token string">&quot;firstName&quot;</span> <span class="token operator">=</span> <span class="token string">'Jennifer'</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token string">&quot;lastName&quot;</span> <span class="token keyword">asc</span>
</code></pre></div><p>The next example shows how easy it is to build complex queries:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> people <span class="token operator">=</span> <span class="token keyword">await</span> Person
  <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'persons.*'</span><span class="token punctuation">,</span> <span class="token string">'Parent.firstName as parentFirstName'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'persons as parent'</span><span class="token punctuation">,</span> <span class="token string">'persons.parentId'</span><span class="token punctuation">,</span> <span class="token string">'parent.id'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'persons.age'</span><span class="token punctuation">,</span> <span class="token string">'&lt;'</span><span class="token punctuation">,</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">avg</span><span class="token punctuation">(</span><span class="token string">'persons.age'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">whereExists</span><span class="token punctuation">(</span>
    Animal<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">whereColumn</span><span class="token punctuation">(</span><span class="token string">'persons.id'</span><span class="token punctuation">,</span> <span class="token string">'animals.ownerId'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">'persons.lastName'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>parentFirstName<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token string">&quot;persons&quot;</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token string">&quot;parent&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;firstName&quot;</span> <span class="token keyword">as</span> <span class="token string">&quot;parentFirstName&quot;</span>
<span class="token keyword">from</span> <span class="token string">&quot;persons&quot;</span>
<span class="token keyword">inner</span> <span class="token keyword">join</span> <span class="token string">&quot;persons&quot;</span>
  <span class="token keyword">as</span> <span class="token string">&quot;parent&quot;</span>
  <span class="token keyword">on</span> <span class="token string">&quot;persons&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;parentId&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;parent&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;id&quot;</span>
<span class="token keyword">where</span> <span class="token string">&quot;persons&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;age&quot;</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span>
  <span class="token keyword">select</span> <span class="token function">avg</span><span class="token punctuation">(</span><span class="token string">&quot;persons&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">)</span>
  <span class="token keyword">from</span> <span class="token string">&quot;persons&quot;</span>
<span class="token punctuation">)</span>
<span class="token operator">and</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span>
  <span class="token keyword">select</span> <span class="token number">1</span>
  <span class="token keyword">from</span> <span class="token string">&quot;animals&quot;</span>
  <span class="token keyword">where</span> <span class="token string">&quot;persons&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;id&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;animals&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;ownerId&quot;</span>
<span class="token punctuation">)</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token string">&quot;persons&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;lastName&quot;</span> <span class="token keyword">asc</span>
</code></pre></div><p>In addition to knex methods, the <a href="/objection.js/api/query-builder/">QueryBuilder</a> has a lot of helpers for dealing with relations like the <a href="/objection.js/api/query-builder/join-methods.html#joinrelation">joinRelation</a> method:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> people <span class="token operator">=</span> <span class="token keyword">await</span> Person
  <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'parent:parent.name as grandParentName'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">joinRelation</span><span class="token punctuation">(</span><span class="token string">'parent.parent'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>grandParentName<span class="token punctuation">)</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token string">&quot;parent:parent&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;firstName&quot;</span> <span class="token keyword">as</span> <span class="token string">&quot;grandParentName&quot;</span>
<span class="token keyword">from</span> <span class="token string">&quot;persons&quot;</span>
<span class="token keyword">inner</span> <span class="token keyword">join</span> <span class="token string">&quot;persons&quot;</span>
  <span class="token keyword">as</span> <span class="token string">&quot;parent&quot;</span>
  <span class="token keyword">on</span> <span class="token string">&quot;parent&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;id&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;persons&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;parentId&quot;</span>
<span class="token keyword">inner</span> <span class="token keyword">join</span> <span class="token string">&quot;persons&quot;</span>
  <span class="token keyword">as</span> <span class="token string">&quot;parent:parent&quot;</span>
  <span class="token keyword">on</span> <span class="token string">&quot;parent:parent&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;id&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;parent&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;parentId&quot;</span>
</code></pre></div><p>Objection allows a bit more modern syntax with groupings and subqueries. Where knex requires you to use an old fashioned <code>function</code> an <code>this</code>, with objection you can use arrow functions:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> nonMiddleAgedJennifers <span class="token operator">=</span> <span class="token keyword">await</span> Person
  <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token parameter">builder</span> <span class="token operator">=&gt;</span> builder<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token string">'&lt;'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orWhere</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token string">'&gt;'</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'firstName'</span><span class="token punctuation">,</span> <span class="token string">'Jennifer'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">'lastName'</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'The last name of the first non middle aged Jennifer is'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>nonMiddleAgedJennifers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lastName<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token string">&quot;persons&quot;</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&quot;persons&quot;</span>
<span class="token keyword">where</span> <span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span> <span class="token operator">&lt;</span> <span class="token number">40</span> <span class="token operator">or</span> <span class="token string">&quot;age&quot;</span> <span class="token operator">&gt;</span> <span class="token number">60</span><span class="token punctuation">)</span>
<span class="token operator">and</span> <span class="token string">&quot;firstName&quot;</span> <span class="token operator">=</span> <span class="token string">'Jennifer'</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token string">&quot;lastName&quot;</span> <span class="token keyword">asc</span>
</code></pre></div><h3 id="insert-queries"><a href="#insert-queries" aria-hidden="true" class="header-anchor">#</a> Insert queries</h3> <p>Insert queries are created by chaining the <a href="/objection.js/api/query-builder/mutate-methods.html#insert">insert</a> method to the query. See the <a href="/objection.js/api/query-builder/mutate-methods.html#insertgraph">insertGraph</a> method for inserting object graphs.</p> <p>In addition to the examples here, you can find more examples behind these links.</p> <ul><li><a href="/objection.js/api/query-builder/mutate-methods.html#insert">insert API reference</a></li> <li><a href="/objection.js/guide/query-examples.html#graph-inserts">graph inserts</a></li></ul> <h5 id="examples-2"><a href="#examples-2" aria-hidden="true" class="header-anchor">#</a> Examples</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> jennifer <span class="token operator">=</span> <span class="token keyword">await</span> Person
  <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span> firstName<span class="token punctuation">:</span> <span class="token string">'Jennifer'</span><span class="token punctuation">,</span> lastName<span class="token punctuation">:</span> <span class="token string">'Lawrence'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>jennifer <span class="token keyword">instanceof</span> <span class="token class-name">Person</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// --&gt; true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>jennifer<span class="token punctuation">.</span>firstName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// --&gt; 'Jennifer'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>jennifer<span class="token punctuation">.</span><span class="token function">fullName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// --&gt; 'Jennifer Lawrence'</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token string">&quot;persons&quot;</span> <span class="token punctuation">(</span><span class="token string">&quot;firstName&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;lastName&quot;</span><span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'Jennifer'</span><span class="token punctuation">,</span> <span class="token string">'Lawrence'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="update-queries"><a href="#update-queries" aria-hidden="true" class="header-anchor">#</a> Update queries</h3> <p>Update queries are created by chaining the <a href="/objection.js/api/query-builder/mutate-methods.html#update">update</a> or <a href="/objection.js/api/query-builder/mutate-methods.html#patch">patch</a> method to the query. <a href="/objection.js/api/query-builder/mutate-methods.html#patch">patch</a> and <a href="/objection.js/api/query-builder/mutate-methods.html#update">update</a> return the number of updated rows. If you want the freshly updated model as a result you can use the helper method <a href="/objection.js/api/query-builder/mutate-methods.html#patchandfetchbyid">patchAndFetchById</a> and <a href="/objection.js/api/query-builder/mutate-methods.html#updateandfetchbyid">updateAndFetchById</a>. On postgresql you can simply chain <a href="/objection.js/api/query-builder/find-methods.html#returning">.returning('*')</a> or take a look at <a href="/objection.js/recipes/returning-tricks.html">this recipe</a> for more ideas. See <a href="/objection.js/api/query-builder/mutate-methods.html#update">update</a> and <a href="/objection.js/api/query-builder/mutate-methods.html#patch">patch</a> API documentation for discussion about their differences.</p> <p>In addition to the examples here, you can find more examples behind these links.</p> <ul><li><a href="/objection.js/api/query-builder/mutate-methods.html#patch">patch API reference</a></li> <li><a href="/objection.js/recipes/raw-queries.html">raw queries</a></li></ul> <h5 id="examples-3"><a href="#examples-3" aria-hidden="true" class="header-anchor">#</a> Examples</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> numUpdated <span class="token operator">=</span> <span class="token keyword">await</span> Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">patch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> lastName<span class="token punctuation">:</span> <span class="token string">'Dinosaur'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token string">'&gt;'</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'all people over 60 years old are now dinosaurs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>numUpdated<span class="token punctuation">,</span> <span class="token string">'people were updated'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">update</span> <span class="token string">&quot;persons&quot;</span> <span class="token keyword">set</span> <span class="token string">&quot;lastName&quot;</span> <span class="token operator">=</span> <span class="token string">'Dinosaur'</span> <span class="token keyword">where</span> <span class="token string">&quot;age&quot;</span> <span class="token operator">&gt;</span> <span class="token number">60</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> updatedPerson <span class="token operator">=</span> <span class="token keyword">await</span> Person
  <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">patchAndFetchById</span><span class="token punctuation">(</span><span class="token number">246</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>lastName<span class="token punctuation">:</span> <span class="token string">'Updated'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>updatedPerson<span class="token punctuation">.</span>lastName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// --&gt; Updated.</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">update</span> <span class="token string">&quot;persons&quot;</span> <span class="token keyword">set</span> <span class="token string">&quot;lastName&quot;</span> <span class="token operator">=</span> <span class="token string">'Updated'</span> <span class="token keyword">where</span> <span class="token string">&quot;id&quot;</span> <span class="token operator">=</span> <span class="token number">246</span>
<span class="token keyword">select</span> <span class="token string">&quot;persons&quot;</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&quot;persons&quot;</span> <span class="token keyword">where</span> <span class="token string">&quot;id&quot;</span> <span class="token operator">=</span> <span class="token number">246</span>
</code></pre></div><h3 id="delete-queries"><a href="#delete-queries" aria-hidden="true" class="header-anchor">#</a> Delete queries</h3> <p>Delete queries are created by chaining the <a href="/objection.js/api/query-builder/mutate-methods.html#delete">delete</a> method to the query.</p> <p>NOTE: The return value of the query will be the number of deleted rows. <em>If you're using Postgres take a look at <a href="/objection.js/recipes/returning-tricks.html">this recipe</a> if you'd like the deleted rows to be returned as Model instances</em>.</p> <h5 id="examples-4"><a href="#examples-4" aria-hidden="true" class="header-anchor">#</a> Examples</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> numDeleted <span class="token operator">=</span> <span class="token keyword">await</span> Person
  <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token function">raw</span><span class="token punctuation">(</span><span class="token string">'lower(&quot;firstName&quot;)'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'like'</span><span class="token punctuation">,</span> <span class="token string">'%ennif%'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>numDeleted<span class="token punctuation">,</span> <span class="token string">'people were deleted'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">delete</span> <span class="token keyword">from</span> <span class="token string">&quot;persons&quot;</span> <span class="token keyword">where</span> lower<span class="token punctuation">(</span><span class="token string">&quot;firstName&quot;</span><span class="token punctuation">)</span> <span class="token operator">like</span> <span class="token string">'%ennif%'</span>
</code></pre></div><p>You can always use <a href="/objection.js/recipes/subqueries.html">subqueries</a>, <a href="/objection.js/api/objection/#raw">raw</a>, <a href="/objection.js/api/objection/#ref">ref</a>, <a href="/objection.js/api/objection/#lit">lit</a> and all query building methods with <a href="/objection.js/api/query-builder/mutate-methods.html#delete">delete</a> queries, just like with every query in objection. With some databases, you cannot use joins with deletes (db restriction, not objection). You can replace joins with subqueries like this:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// This query deletes all people that have a pet named &quot;Fluffy&quot;.</span>
<span class="token keyword">await</span> Person
  <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">whereIn</span><span class="token punctuation">(</span>
    <span class="token string">'id'</span><span class="token punctuation">,</span>
    Person<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'persons.id'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">joinRelation</span><span class="token punctuation">(</span><span class="token string">'pets'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'pets.name'</span><span class="token punctuation">,</span> <span class="token string">'Fluffy'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">delete</span> <span class="token keyword">from</span> <span class="token string">&quot;persons&quot;</span>
<span class="token keyword">where</span> <span class="token string">&quot;id&quot;</span> <span class="token operator">in</span> <span class="token punctuation">(</span>
  <span class="token keyword">select</span> <span class="token string">&quot;persons.id&quot;</span>
  <span class="token keyword">from</span> <span class="token string">&quot;persons&quot;</span>
  <span class="token keyword">join</span> <span class="token string">&quot;pets&quot;</span> <span class="token keyword">on</span> <span class="token string">&quot;pets.ownerId&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;persons.id&quot;</span>
  <span class="token keyword">where</span> <span class="token string">&quot;pets.name&quot;</span> <span class="token operator">=</span> <span class="token string">'Fluffy'</span>
<span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// This is another way to implement the previous query.</span>
<span class="token keyword">await</span> Person
  <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">whereExists</span><span class="token punctuation">(</span>
    Person<span class="token punctuation">.</span><span class="token function">relatedQuery</span><span class="token punctuation">(</span><span class="token string">'pets'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'pets.name'</span><span class="token punctuation">,</span> <span class="token string">'Fluffy'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">delete</span> <span class="token keyword">from</span> <span class="token string">&quot;persons&quot;</span>
<span class="token keyword">where</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span>
  <span class="token keyword">select</span> <span class="token string">&quot;pets&quot;</span><span class="token punctuation">.</span><span class="token operator">*</span>
  <span class="token keyword">from</span> <span class="token string">&quot;pets&quot;</span>
  <span class="token keyword">where</span> <span class="token string">&quot;pets.ownerId&quot;</span> <span class="token operator">=</span> <span class="token string">&quot;persons.id&quot;</span>
  <span class="token operator">and</span> <span class="token string">&quot;pets.name&quot;</span> <span class="token operator">=</span> <span class="token string">'Fluffy'</span>
<span class="token punctuation">)</span>
</code></pre></div><h2 id="relation-queries"><a href="#relation-queries" aria-hidden="true" class="header-anchor">#</a> Relation queries</h2> <p>While the static <a href="/objection.js/api/model/static-methods.html#static-query">query</a> method can be used to create a query to a whole table <a href="/objection.js/api/model/instance-methods.html#relatedquery">$relatedQuery</a> method can be used to query a single relation. <a href="/objection.js/api/model/instance-methods.html#relatedquery">$relatedQuery</a> returns an instance of <a href="/objection.js/api/query-builder/">QueryBuilder</a> just like the <a href="/objection.js/api/model/static-methods.html#static-query">query</a> method.</p> <h3 id="find-queries-2"><a href="#find-queries-2" aria-hidden="true" class="header-anchor">#</a> Find queries</h3> <p>Simply call <a href="/objection.js/api/model/instance-methods.html#relatedquery">$relatedQuery('relationName')</a> for a model <em>instance</em> to fetch a relation for it. The relation name is given as the only argument. The return value is a <a href="/objection.js/api/query-builder/">QueryBuilder</a> so you once again have all the query methods at your disposal. In many cases it's more convenient to use <a href="/objection.js/guide/query-examples.html#eager-loading">eager loading</a> to fetch relations. <a href="/objection.js/api/model/instance-methods.html#relatedquery">$relatedQuery</a> is better when you only need one relation and you need to filter the query extensively.</p> <p>By default the fetched related models are assigned to the parent model to a property by the same name as the relation. For example in our <code>person.$relatedQuery('pets')</code> example query, the return value would be assigned to <code>person.pets</code>. This behaviour can be modified using <a href="/objection.js/api/model/static-properties.html#static-relatedfindquerymutates">relatedFindQueryMutates</a>. Also check out <a href="/objection.js/api/model/instance-methods.html#setrelated">$setRelated</a> and <a href="/objection.js/api/model/instance-methods.html#appendrelated">$appendRelated</a> helpers.</p> <h5 id="examples-5"><a href="#examples-5" aria-hidden="true" class="header-anchor">#</a> Examples</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// `person` is an instance of `Person` model.</span>
<span class="token keyword">const</span> pets <span class="token operator">=</span> <span class="token keyword">await</span> person
  <span class="token punctuation">.</span><span class="token function">$relatedQuery</span><span class="token punctuation">(</span><span class="token string">'pets'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'species'</span><span class="token punctuation">,</span> <span class="token string">'dog'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>pets <span class="token operator">===</span> pets<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// --&gt; true</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>pets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">instanceof</span> <span class="token class-name">Animal</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// --&gt; true</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token string">&quot;animals&quot;</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">from</span> <span class="token string">&quot;animals&quot;</span>
<span class="token keyword">where</span> <span class="token string">&quot;species&quot;</span> <span class="token operator">=</span> <span class="token string">'dog'</span>
<span class="token operator">and</span> <span class="token string">&quot;animals&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;ownerId&quot;</span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token string">&quot;name&quot;</span> <span class="token keyword">asc</span>
</code></pre></div><h3 id="insert-queries-2"><a href="#insert-queries-2" aria-hidden="true" class="header-anchor">#</a> Insert queries</h3> <p>Chain the <a href="/objection.js/api/query-builder/mutate-methods.html#insert">insert</a> method to a <a href="/objection.js/api/model/instance-methods.html#relatedquery">$relatedQuery</a> call to insert a related object for a model <em>instance</em>. The query inserts a new object to the related table and updates the needed tables to create the relation. In case of many-to-many relation a row is inserted to the join table etc. Also check out <a href="/objection.js/api/query-builder/mutate-methods.html#insertgraph">insertGraph</a> method for an alternative way to insert related models.</p> <p>By default the inserted related models are appended to the parent model to a property by the same name as the relation. For example in our <code>person.$relatedQuery('pets').insert(obj)</code> example query, the return value would be appended to <code>person.pets</code>. This behaviour can be modified using <a href="/objection.js/api/model/static-properties.html#static-relatedinsertquerymutates">relatedInsertQueryMutates</a>. Also check out the <a href="/objection.js/api/model/instance-methods.html#setrelated">$setRelated</a> and
<a href="/objection.js/api/model/instance-methods.html#appendrelated">$appendRelated</a> helpers.</p> <h5 id="examples-6"><a href="#examples-6" aria-hidden="true" class="header-anchor">#</a> Examples</h5> <p>Add a pet for a person:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// `person` is an instance of `Person` model.</span>
<span class="token keyword">const</span> fluffy <span class="token operator">=</span> <span class="token keyword">await</span> person
  <span class="token punctuation">.</span><span class="token function">$relatedQuery</span><span class="token punctuation">(</span><span class="token string">'pets'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'Fluffy'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>pets<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>fluffy<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// --&gt; true</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token string">&quot;animals&quot;</span> <span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ownerId&quot;</span><span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'Fluffy'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre></div><p>If you want to write columns to the join table of a many-to-many relation you first need to specify the columns in the <code>extra</code> array of the <code>through</code> object in <a href="/objection.js/api/model/static-properties.html#static-relationmappings">relationMappings</a> (see the examples behind the link). For example, if you specified an array <code>extra: ['awesomeness']</code> in <a href="/objection.js/api/model/static-properties.html#static-relationmappings">relationMappings</a> then <code>awesomeness</code> is written to the join table in the following example:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// `person` is an instance of `Person` model.</span>
<span class="token keyword">const</span> movie <span class="token operator">=</span> <span class="token keyword">await</span> person
  <span class="token punctuation">.</span><span class="token function">$relatedQuery</span><span class="token punctuation">(</span><span class="token string">'movies'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'The room'</span><span class="token punctuation">,</span> awesomeness<span class="token punctuation">:</span> <span class="token number">9001</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'best movie ever was added'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token string">&quot;movies&quot;</span> <span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'The room'</span><span class="token punctuation">)</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> <span class="token string">&quot;persons_movies&quot;</span> <span class="token punctuation">(</span><span class="token string">&quot;movieId&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;personId&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;awesomeness&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">9001</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="update-queries-2"><a href="#update-queries-2" aria-hidden="true" class="header-anchor">#</a> Update queries</h3> <p>See the <a href="/objection.js/api/query-builder/mutate-methods.html#update">API documentation</a> of <code>update</code> method.</p> <h3 id="delete-queries-2"><a href="#delete-queries-2" aria-hidden="true" class="header-anchor">#</a> Delete queries</h3> <p>See the <a href="/objection.js/api/query-builder/mutate-methods.html#delete">API documentation</a> of <code>delete</code> method.</p> <h3 id="relate-queries"><a href="#relate-queries" aria-hidden="true" class="header-anchor">#</a> Relate queries</h3> <p>See the <a href="/objection.js/api/query-builder/mutate-methods.html#relate">API documentation</a> of <code>relate</code> method.</p> <h3 id="unrelate-queries"><a href="#unrelate-queries" aria-hidden="true" class="header-anchor">#</a> Unrelate queries</h3> <p>See the <a href="/objection.js/api/query-builder/mutate-methods.html#unrelate">API documentation</a> of <code>unrelate</code> method.</p> <h2 id="eager-loading"><a href="#eager-loading" aria-hidden="true" class="header-anchor">#</a> Eager loading</h2> <p>You can fetch an arbitrary graph of relations for the results of any query by chaining the <a href="/objection.js/api/query-builder/eager-methods.html#eager">eager</a> method. <a href="/objection.js/api/query-builder/eager-methods.html#eager">eager</a> takes a <a href="/objection.js/api/types/#type-relationexpression">relation expression</a> string as a parameter. In addition to making your life easier, eager queries avoid the &quot;select N+1&quot; problem and provide a great performance.</p> <p>Because the eager expressions are strings (there's also an optional <a href="/objection.js/api/types/#relationexpression-object-notation">object notation</a>) they can be easily passed for example as a query parameter of an HTTP request. However, allowing the client to execute expressions like this without any limitations is not very secure. Therefore the <a href="/objection.js/api/query-builder/">QueryBuilder</a> has the <a href="/objection.js/api/query-builder/eager-methods.html#alloweager">allowEager</a> method. <a href="/objection.js/api/query-builder/eager-methods.html#alloweager">allowEager</a> can be used to  limit the allowed eager expression to a certain subset.</p> <p>By giving expression <code>[pets, children.pets]</code> for <a href="/objection.js/api/query-builder/eager-methods.html#alloweager">allowEager</a> the value passed to <a href="/objection.js/api/query-builder/eager-methods.html#eager">eager</a> is allowed to be one of:</p> <ul><li><code>'pets'</code></li> <li><code>'children'</code></li> <li><code>'children.pets'</code></li> <li><code>'[pets, children]'</code></li> <li><code>'[pets, children.pets]'</code></li></ul> <p>Examples of expressions that would cause the query to be rejected:</p> <ul><li><code>'movies'</code></li> <li><code>'children.children'</code></li> <li><code>'[pets, children.children]'</code></li> <li><code>'notEvenAnExistingRelation'</code></li></ul> <p>In addition to the <a href="/objection.js/api/query-builder/eager-methods.html#eager">eager</a> method, relations can be fetched using the <a href="/objection.js/api/model/static-properties.html#static-loadrelated">loadRelated</a> and
<a href="/objection.js/api/model/instance-methods.html#loadrelated">$loadRelated</a> methods.</p> <p>By default eager loading is done using multiple separate queries (for details see <a href="https://www.vincit.fi/en/blog/nested-eager-loading-and-inserts-with-objection-js/" target="_blank" rel="noopener noreferrer">this blog post<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>). You can choose to use a join based eager loading algorithm that only performs one single query to fetch the whole eager tree. You can select which algorithm to use per query using <a href="/objection.js/api/query-builder/eager-methods.html#eageralgorithm">eagerAlgorithm</a> method or per model by setting the <a href="/objection.js/api/model/static-properties.html#static-defaulteageralgorithm">defaultEagerAlgorithm</a> property. All algorithms have their strengths and weaknesses, which are discussed in detail <a href="/objection.js/api/query-builder/eager-methods.html#eager">here</a>.</p> <h5 id="examples-7"><a href="#examples-7" aria-hidden="true" class="header-anchor">#</a> Examples</h5> <p>Fetch the <code>pets</code> relation for all results of a query:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> people <span class="token operator">=</span> <span class="token keyword">await</span> Person
  <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">eager</span><span class="token punctuation">(</span><span class="token string">'pets'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Each person has the `.pets` property populated with Animal objects related</span>
<span class="token comment">// through `pets` relation.</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">instanceof</span> <span class="token class-name">Animal</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// --&gt; true</span>
</code></pre></div><p>Fetch multiple relations on multiple levels:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> people <span class="token operator">=</span> <span class="token keyword">await</span> Person
  <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">eager</span><span class="token punctuation">(</span><span class="token string">'[pets, children.[pets, children]]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Each person has the `.pets` property populated with Animal objects related</span>
<span class="token comment">// through `pets` relation. The `.children` property contains the Person's</span>
<span class="token comment">// children. Each child also has the `pets` and `children` relations eagerly</span>
<span class="token comment">// fetched.</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pets<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Here's the previous query using the optional <a href="/objection.js/api/types/#relationexpression-object-notation">object notation</a></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> people <span class="token operator">=</span> <span class="token keyword">await</span> Person
  <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">eager</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    pets<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    children<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      pets<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      children<span class="token punctuation">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Fetch one relation recursively:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> people <span class="token operator">=</span> <span class="token keyword">await</span> Person
  <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">eager</span><span class="token punctuation">(</span><span class="token string">'[pets, children.^]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// The children relation is from Person to Person. If we want to fetch the whole</span>
<span class="token comment">// descendant tree of a person we can just say &quot;fetch this relation recursively&quot;</span>
<span class="token comment">// using the `.^` notation.</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>firstName<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Limit recursion to 3 levels:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> people <span class="token operator">=</span> <span class="token keyword">await</span> Person
  <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">eager</span><span class="token punctuation">(</span><span class="token string">'[pets, children.^3]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>firstName<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Relations can be modified using the <a href="/objection.js/api/query-builder/other-methods.html#modifyeager">modifyEager</a> method:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> people <span class="token operator">=</span> <span class="token keyword">await</span> Person
  <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">eager</span><span class="token punctuation">(</span><span class="token string">'[children.[pets, movies], movies]'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">modifyEager</span><span class="token punctuation">(</span><span class="token string">'children.pets'</span><span class="token punctuation">,</span> <span class="token parameter">builder</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Only select pets older than 10 years old for children</span>
    <span class="token comment">// and only return their names.</span>
    builder<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">,</span> <span class="token string">'&gt;'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Relations can also be modified using named filters like this:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> people <span class="token operator">=</span> <span class="token keyword">await</span> Person
  <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">eager</span><span class="token punctuation">(</span><span class="token string">'[pets(selectName, onlyDogs), children(orderByAge).[pets, children]]'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">selectName</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">builder</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      builder<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">orderByAge</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">builder</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      builder<span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">onlyDogs</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">builder</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      builder<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'species'</span><span class="token punctuation">,</span> <span class="token string">'dog'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>movies<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Reusable named filters can be defined for models using <a href="/objection.js/api/model/static-properties.html#static-modifiers">modifiers</a></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Person.js</span>

<span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token keyword">get</span> <span class="token function">modifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token function">defaultSelects</span><span class="token punctuation">(</span><span class="token parameter">builder</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        builder<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> <span class="token string">'firstName'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>

      <span class="token function">orderByAge</span><span class="token punctuation">(</span><span class="token parameter">builder</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        builder<span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Animal.js</span>

<span class="token keyword">class</span> <span class="token class-name">Animal</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token keyword">get</span> <span class="token function">modifiers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token function">orderByName</span><span class="token punctuation">(</span><span class="token parameter">builder</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        builder<span class="token punctuation">.</span><span class="token function">orderBy</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>

      <span class="token function">onlyDogs</span><span class="token punctuation">(</span><span class="token parameter">builder</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        builder<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'species'</span><span class="token punctuation">,</span> <span class="token string">'dog'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// somewhereElse.js</span>

<span class="token keyword">const</span> people <span class="token operator">=</span> <span class="token keyword">await</span> Person
  <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">eager</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`
    children(defaultSelects, orderByAge).[
      pets(onlyDogs, orderByName),
      movies
    ]
  `</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>pets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>movies<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Relations can be aliased using <code>as</code> keyword:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> people <span class="token operator">=</span> <span class="token keyword">await</span> Person
  <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">eager</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`[
    children(orderByAge) as kids .[
      pets(filterDogs) as dogs,
      pets(filterCats) as cats

      movies.[
        actors
      ]
    ]
  ]`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>kids<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>dogs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>people<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>kids<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>movies<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Example usage for <a href="/objection.js/api/query-builder/eager-methods.html#alloweager">allowEager</a> in an express route:</p> <div class="language-js extra-class"><pre class="language-js"><code>expressApp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/people'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> people <span class="token operator">=</span> <span class="token keyword">await</span> Person
    <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">allowEager</span><span class="token punctuation">(</span><span class="token string">'[pets, children.pets]'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">eager</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>eager<span class="token punctuation">)</span><span class="token punctuation">;</span>

  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>people<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Eager loading algorithm can be changed using the <a href="/objection.js/api/query-builder/eager-methods.html#eageralgorithm">eagerAlgorithm</a> method:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> people <span class="token operator">=</span> <span class="token keyword">await</span> Person
  <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">eagerAlgorithm</span><span class="token punctuation">(</span>Model<span class="token punctuation">.</span>JoinEagerAlgorithm<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">eager</span><span class="token punctuation">(</span><span class="token string">'[pets, children.pets]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>There are also shortcut methods for each of the eager algoriths:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> people <span class="token operator">=</span> <span class="token keyword">await</span> Person
  <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">joinEager</span><span class="token punctuation">(</span><span class="token string">'[pets, children.pets]'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="graph-inserts"><a href="#graph-inserts" aria-hidden="true" class="header-anchor">#</a> Graph inserts</h2> <p>Arbitrary relation graphs can be inserted using the <a href="/objection.js/api/query-builder/mutate-methods.html#insertgraph">insertGraph</a> method. This is best explained using examples, so check them out.</p> <p>See the <a href="/objection.js/api/query-builder/mutate-methods.html#allowinsert">allowInsert</a> method if you need to limit which relations can be inserted using <a href="/objection.js/api/query-builder/mutate-methods.html#insertgraph">insertGraph</a> method to avoid security issues. <a href="/objection.js/api/query-builder/mutate-methods.html#allowinsert">allowInsert</a> works like <a href="/objection.js/api/query-builder/mutate-methods.html#allowinsert">allowEager</a>.</p> <p>If you are using Postgres the inserts are done in batches for maximum performance. On other databases the rows need to be inserted one at a time. This is because postgresql is the only database engine that returns the identifiers of all inserted rows and not just the first or the last one.</p> <p><a href="/objection.js/api/query-builder/mutate-methods.html#insertgraph">insertGraph</a> operation is <strong>not</strong> atomic by default! You need to start a transaction and pass it to the query using any of the supported ways. See the section about <a href="/objection.js/guide/transactions.html">transactions</a> for more information.</p> <p>You can read more about graph inserts from <a href="https://www.vincit.fi/en/blog/nested-eager-loading-and-inserts-with-objection-js/" target="_blank" rel="noopener noreferrer">this blog post<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.</p> <h5 id="examples-8"><a href="#examples-8" aria-hidden="true" class="header-anchor">#</a> Examples</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// The return value of `insertGraph` is the input graph converted into</span>
<span class="token comment">// model instances. Inserted objects have ids added to them and related</span>
<span class="token comment">// rows have foreign keys set, but no other columns get fetched from</span>
<span class="token comment">// the database. You can use `insertGraphAndFetch` for that.</span>
<span class="token keyword">const</span> graph <span class="token operator">=</span> <span class="token keyword">await</span> Person
  <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">insertGraph</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    firstName<span class="token punctuation">:</span> <span class="token string">'Sylvester'</span><span class="token punctuation">,</span>
    lastName<span class="token punctuation">:</span> <span class="token string">'Stallone'</span><span class="token punctuation">,</span>

    children<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      firstName<span class="token punctuation">:</span> <span class="token string">'Sage'</span><span class="token punctuation">,</span>
      lastName<span class="token punctuation">:</span> <span class="token string">'Stallone'</span><span class="token punctuation">,</span>

      pets<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        name<span class="token punctuation">:</span> <span class="token string">'Fluffy'</span><span class="token punctuation">,</span>
        species<span class="token punctuation">:</span> <span class="token string">'dog'</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The query above will insert 'Sylvester', 'Sage' and 'Fluffy' into db and create relationships between them as defined in the <a href="/objection.js/api/model/static-properties.html#static-relationmappings">relationMappings</a> of the models. Technically <a href="/objection.js/api/query-builder/mutate-methods.html#insertgraph">insertGraph</a> builds a dependency graph from the object graph and inserts the models that don't depend on any other models until the whole graph is inserted.</p> <p>If you need to refer to the same model in multiple places you can use the special properties <code>#id</code> and <code>#ref</code> like this:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> Person
  <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">insertGraph</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span>
    firstName<span class="token punctuation">:</span> <span class="token string">'Jennifer'</span><span class="token punctuation">,</span>
    lastName<span class="token punctuation">:</span> <span class="token string">'Lawrence'</span><span class="token punctuation">,</span>

    movies<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      <span class="token string">&quot;#id&quot;</span><span class="token punctuation">:</span> <span class="token string">'silverLiningsPlaybook'</span>
      name<span class="token punctuation">:</span> <span class="token string">'Silver Linings Playbook'</span><span class="token punctuation">,</span>
      duration<span class="token punctuation">:</span> <span class="token number">122</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    firstName<span class="token punctuation">:</span> <span class="token string">'Bradley'</span><span class="token punctuation">,</span>
    lastName<span class="token punctuation">:</span> <span class="token string">'Cooper'</span><span class="token punctuation">,</span>

    movies<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      <span class="token string">&quot;#ref&quot;</span><span class="token punctuation">:</span> <span class="token string">'silverLiningsPlaybook'</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The query above will insert only one movie (the 'Silver Linings Playbook') but both 'Jennifer' and 'Bradley' will have the movie related to them through the many-to-many relation <code>movies</code>. The <code>#id</code> can be any string. There are no format or length requirements for them. It is quite easy to create circular dependencies using <code>#id</code> and <code>#ref</code>. Luckily <a href="/objection.js/api/query-builder/mutate-methods.html#insertgraph">insertGraph</a> detects them and rejects the query with a clear error message.</p> <p>You can refer to the properties of other models anywhere in the graph using expressions of format <code>#ref{&lt;id&gt;.&lt;property&gt;}</code> as long as the reference doesn't create a circular dependency. For example:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> Person
  <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">insertGraph</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span>
    <span class="token string">&quot;#id&quot;</span><span class="token punctuation">:</span> <span class="token string">'jenni'</span><span class="token punctuation">,</span>
    firstName<span class="token punctuation">:</span> <span class="token string">'Jennifer'</span><span class="token punctuation">,</span>
    lastName<span class="token punctuation">:</span> <span class="token string">'Lawrence'</span><span class="token punctuation">,</span>

    pets<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      name<span class="token punctuation">:</span> <span class="token string">&quot;I am the dog of #ref{jenni.firstName} whose id is #ref{jenni.id}&quot;</span><span class="token punctuation">,</span>
      species<span class="token punctuation">:</span> <span class="token string">'dog'</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The query above will insert a pet named <code>I am the dog of Jennifer whose id is 523</code> for Jennifer. If <code>#ref{}</code> is used within a string, the references are replaced with the referred values inside the string. If the reference string contains nothing but the reference, the referred value is copied to it's place preserving its type.</p> <p>Existing rows can be related to newly inserted rows by using the <code>relate</code> option. <code>relate</code> can be <code>true</code> in which case all models in the graph that have an identifier get related. <code>relate</code> can also be an array of relation paths like <code>['children', 'children.movies.actors']</code> in which case only objects in those paths get related even if they have an idetifier.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> Person
  <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">insertGraph</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span>
    firstName<span class="token punctuation">:</span> <span class="token string">'Jennifer'</span><span class="token punctuation">,</span>
    lastName<span class="token punctuation">:</span> <span class="token string">'Lawrence'</span><span class="token punctuation">,</span>

    movies<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      id<span class="token punctuation">:</span> <span class="token number">2636</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    relate<span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The query above would create a new person <code>Jennifer Lawrence</code> and add an existing movie (id = 2636) to its <code>movies</code> relation. The next query would do the same:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> Person
  <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">insertGraph</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span>
    firstName<span class="token punctuation">:</span> <span class="token string">'Jennifer'</span><span class="token punctuation">,</span>
    lastName<span class="token punctuation">:</span> <span class="token string">'Lawrence'</span><span class="token punctuation">,</span>

    movies<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      id<span class="token punctuation">:</span> <span class="token number">2636</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    relate<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token string">'movies'</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The <code>relate</code> option can also contain nested relations:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> Person
  <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">insertGraph</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span>
    firstName<span class="token punctuation">:</span> <span class="token string">'Jennifer'</span><span class="token punctuation">,</span>
    lastName<span class="token punctuation">:</span> <span class="token string">'Lawrence'</span><span class="token punctuation">,</span>

    movies<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      name<span class="token punctuation">:</span> <span class="token string">'Silver Linings Playbook'</span><span class="token punctuation">,</span>
      duration<span class="token punctuation">:</span> <span class="token number">122</span><span class="token punctuation">,</span>

      actors<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        id<span class="token punctuation">:</span> <span class="token number">2516</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    relate<span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token string">'movies.actors'</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>If you need to mix inserts and relates inside a single relation, you can use the special property <code>#dbRef</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">await</span> Person
  <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">insertGraph</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">{</span>
    firstName<span class="token punctuation">:</span> <span class="token string">'Jennifer'</span><span class="token punctuation">,</span>
    lastName<span class="token punctuation">:</span> <span class="token string">'Lawrence'</span><span class="token punctuation">,</span>

    movies<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      <span class="token string">&quot;#dbRef&quot;</span><span class="token punctuation">:</span> <span class="token number">2636</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token comment">// This will be inserted with an id.</span>
      id<span class="token punctuation">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
      name<span class="token punctuation">:</span> <span class="token string">'New movie'</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="graph-upserts"><a href="#graph-upserts" aria-hidden="true" class="header-anchor">#</a> Graph upserts</h2> <p>Arbitrary relation graphs can be upserted (insert + update + delete) using the <a href="/objection.js/api/query-builder/mutate-methods.html#upsertgraph">upsertGraph</a> method. This is best explained using examples, so check them out.</p> <p>By default <a href="/objection.js/api/query-builder/mutate-methods.html#upsertgraph">upsertGraph</a> method updates the objects that have an id, inserts objects that don't have an id and deletes all objects that are not present. This functionality can be modified in many ways by providing <a href="/objection.js/api/types/#type-upsertgraphoptions">UpsertGraphOptions</a> object as the second argument.</p> <p>The <a href="/objection.js/api/query-builder/mutate-methods.html#upsertgraph">upsertGraph</a> method works a little different than the other update and patch methods. When using <a href="/objection.js/api/query-builder/mutate-methods.html#upsertgraph">upsertGraph</a> any <code>where</code> or <code>having</code> methods are ignored. The models are updated based on the id properties in the graph. This is also clarified in the examples.</p> <p><a href="/objection.js/api/query-builder/mutate-methods.html#upsertgraph">upsertGraph</a> uses <a href="/objection.js/api/query-builder/mutate-methods.html#insertgraph">insertGraph</a> under the hood for inserts. That means that you can insert object graphs for relations and use all <a href="/objection.js/api/query-builder/mutate-methods.html#insertgraph">insertGraph</a> features like <code>#ref</code> references.</p> <p><a href="/objection.js/api/query-builder/mutate-methods.html#upsertgraph">upsertGraph</a> operation is <strong>not</strong> atomic by default! You need to start a transaction and pass it to the query using any of the supported ways. See the section about <a href="/objection.js/guide/transactions.html">transactions</a> for more information.</p> <p>See the <a href="/objection.js/api/query-builder/mutate-methods.html#allowupsert">allowUpsert</a> method if you need to limit  which relations can be modified using <a href="/objection.js/api/query-builder/mutate-methods.html#upsertgraph">upsertGraph</a> method to avoid security issues. <a href="/objection.js/api/query-builder/mutate-methods.html#allowupsert">allowUpsert</a> works like <a href="/objection.js/api/query-builder/mutate-methods.html#allowinsert">allowInsert</a>.</p> <h5 id="examples-9"><a href="#examples-9" aria-hidden="true" class="header-anchor">#</a> Examples</h5> <p>For the following examples, assume this is the content of the database:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">[</span><span class="token punctuation">{</span>
  id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  firstName<span class="token punctuation">:</span> <span class="token string">'Jennifer'</span><span class="token punctuation">,</span>
  lastName<span class="token punctuation">:</span> <span class="token string">'Aniston'</span><span class="token punctuation">,</span>

  <span class="token comment">// This is a BelongsToOneRelation</span>
  parent<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    firstName<span class="token punctuation">:</span> <span class="token string">'Nancy'</span><span class="token punctuation">,</span>
    lastName<span class="token punctuation">:</span> <span class="token string">'Dow'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">// This is a HasManyRelation</span>
  pets<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> <span class="token string">'Doggo'</span><span class="token punctuation">,</span>
    species<span class="token punctuation">:</span> <span class="token string">'Dog'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> <span class="token string">'Kat'</span><span class="token punctuation">,</span>
    species<span class="token punctuation">:</span> <span class="token string">'Cat'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

  <span class="token comment">// This is a ManyToManyRelation</span>
  movies<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    name<span class="token punctuation">:</span> <span class="token string">'Horrible Bosses'</span><span class="token punctuation">,</span>

    reviews<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      title<span class="token punctuation">:</span> <span class="token string">'Meh'</span><span class="token punctuation">,</span>
      stars<span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
      text<span class="token punctuation">:</span> <span class="token string">'Meh'</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token number">2</span>
    name<span class="token punctuation">:</span> <span class="token string">'Wanderlust'</span><span class="token punctuation">,</span>

    reviews<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      id<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      title<span class="token punctuation">:</span> <span class="token string">'Brilliant'</span><span class="token punctuation">,</span>
      stars<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
      text<span class="token punctuation">:</span> <span class="token string">'Makes me want to travel'</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span>
</code></pre></div><p>By default <a href="/objection.js/api/query-builder/mutate-methods.html#upsertgraph">upsertGraph</a> method updates the objects that have an id, inserts objects that don't have an id and deletes all objects that are not present. Off course the delete only applies to relations and not the root. Here's a basic example:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// The return value of `upsertGraph` is the input graph converted into</span>
<span class="token comment">// model instances. Inserted objects have ids added to them related</span>
<span class="token comment">// rows have foreign keys set but no other columns get fetched from</span>
<span class="token comment">// the database. You can use `upsertGraphAndFetch` for that.</span>
<span class="token keyword">const</span> graph <span class="token operator">=</span> <span class="token keyword">await</span> Person
  <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">upsertGraph</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// This updates the `Jennifer Aniston` person since the id property is present.</span>
    id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    firstName<span class="token punctuation">:</span> <span class="token string">'Jonnifer'</span><span class="token punctuation">,</span>

    parent<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// This also gets updated since the id property is present. If no id was given</span>
      <span class="token comment">// here, Nancy Dow would get deleted, a new Person John Aniston would</span>
      <span class="token comment">// get inserted and related to Jennifer.</span>
      id<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
      firstName<span class="token punctuation">:</span> <span class="token string">'John'</span><span class="token punctuation">,</span>
      lastName<span class="token punctuation">:</span> <span class="token string">'Aniston'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// Notice that Kat the Cat is not listed in `pets`. It will get deleted.</span>
    pets<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      <span class="token comment">// Jennifer just got a new pet. Insert it and relate it to Jennifer. Notice</span>
      <span class="token comment">// that there is no id!</span>
      name<span class="token punctuation">:</span> <span class="token string">'Wolfgang'</span><span class="token punctuation">,</span>
      species<span class="token punctuation">:</span> <span class="token string">'Dog'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token comment">// It turns out Doggo is a cat. Update it.</span>
      id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      species<span class="token punctuation">:</span> <span class="token string">'Cat'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token comment">// Notice that Wanderlust is missing from the list. It will get deleted.</span>
    <span class="token comment">// It is also worth mentioning that the Wanderlust's `reviews` or any</span>
    <span class="token comment">// other relations are NOT recursively deleted (unless you have</span>
    <span class="token comment">// defined `ON DELETE CASCADE` or other hooks in the db).</span>
    movies<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>

      <span class="token comment">// Upsert graphs can be arbitrarily deep. This modifies the</span>
      <span class="token comment">// reviews of &quot;Horrible Bosses&quot;.</span>
      reviews<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token comment">// Update a review.</span>
        id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        stars<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        text<span class="token punctuation">:</span> <span class="token string">'Even more Meh'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token comment">// And insert another one.</span>
        stars<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
        title<span class="token punctuation">:</span> <span class="token string">'Loved it'</span><span class="token punctuation">,</span>
        text<span class="token punctuation">:</span> <span class="token string">'Best movie ever'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token comment">// And insert a third one.</span>
        stars<span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
        title<span class="token punctuation">:</span> <span class="token string">'4 / 5'</span><span class="token punctuation">,</span>
        text<span class="token punctuation">:</span> <span class="token string">'Would see again'</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>By giving <code>relate: true</code> and/or <code>unrelate: true</code> options as the second argument, you can change the behaviour so that instead of inserting and deleting rows, they are related and/or unrelated. Rows with no id still get inserted, but rows that have an id and are not currently related, get related.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
  relate<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  unrelate<span class="token punctuation">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">await</span> Person
  <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">upsertGraph</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token comment">// This updates the `Jennifer Aniston` person since the id property is present.</span>
    id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    firstName<span class="token punctuation">:</span> <span class="token string">'Jonnifer'</span><span class="token punctuation">,</span>

    <span class="token comment">// Unrelate the parent. This doesn't delete it.</span>
    parent<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

    <span class="token comment">// Notice that Kat the Cat is not listed in `pets`. It will get unrelated.</span>
    pets<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      <span class="token comment">// Jennifer just got a new pet. Insert it and relate it to Jennifer. Notice</span>
      <span class="token comment">// that there is no id!</span>
      name<span class="token punctuation">:</span> <span class="token string">'Wolfgang'</span><span class="token punctuation">,</span>
      species<span class="token punctuation">:</span> <span class="token string">'Dog'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token comment">// It turns out Doggo is a cat. Update it.</span>
      id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      species<span class="token punctuation">:</span> <span class="token string">'Cat'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token comment">// Notice that Wanderlust is missing from the list. It will get unrelated.</span>
    movies<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>

      <span class="token comment">// Upsert graphs can be arbitrarily deep. This modifies the</span>
      <span class="token comment">// reviews of &quot;Horrible Bosses&quot;.</span>
      reviews<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token comment">// Update a review.</span>
        id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        stars<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        text<span class="token punctuation">:</span> <span class="token string">'Even more Meh'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token comment">// And insert another one.</span>
        stars<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
        title<span class="token punctuation">:</span> <span class="token string">'Loved it'</span><span class="token punctuation">,</span>
        text<span class="token punctuation">:</span> <span class="token string">'Best movie ever'</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token comment">// This is some existing movie that isn't currently related to Jennifer.</span>
      <span class="token comment">// It will get related.</span>
      id<span class="token punctuation">:</span> <span class="token number">1253</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>relate</code> and <code>unrelate</code> (and all other <a href="/objection.js/api/types/#type-upsertgraphoptions">options</a> can also be lists of relation paths. In that case the option is only applied for the listed relations.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// Only enable `unrelate` functionality for these two paths.</span>
  unrelate<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'pets'</span><span class="token punctuation">,</span> <span class="token string">'movies.reviews'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// Only enable `relate` functionality for 'movies' relation.</span>
  relate<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'movies'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// Disable deleting for movies.</span>
  noDelete<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'movies'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">await</span> Person
  <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">upsertGraph</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>

    <span class="token comment">// This gets deleted since `unrelate` list doesn't have 'parent' in it</span>
    <span class="token comment">// and deleting is the default behaviour.</span>
    parent<span class="token punctuation">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

    <span class="token comment">// Notice that Kat the Cat is not listed in `pets`. It will get unrelated.</span>
    pets<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      <span class="token comment">// It turns out Doggo is a cat. Update it.</span>
      id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
      species<span class="token punctuation">:</span> <span class="token string">'Cat'</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>

    <span class="token comment">// Notice that Wanderlust is missing from the list. It will NOT get unrelated</span>
    <span class="token comment">// or deleted since `unrelate` list doesn't contain `movies` and `noDelete`</span>
    <span class="token comment">// list does.</span>
    movies<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
      id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>

      <span class="token comment">// Upsert graphs can be arbitrarily deep. This modifies the</span>
      <span class="token comment">// reviews of &quot;Horrible Bosses&quot;.</span>
      reviews<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        <span class="token comment">// Update a review.</span>
        id<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        stars<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        text<span class="token punctuation">:</span> <span class="token string">'Even more Meh'</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token comment">// And insert another one.</span>
        stars<span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
        title<span class="token punctuation">:</span> <span class="token string">'Loved it'</span><span class="token punctuation">,</span>
        text<span class="token punctuation">:</span> <span class="token string">'Best movie ever'</span>
      <span class="token punctuation">}</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token comment">// This is some existing movie that isn't currently related to Jennifer.</span>
      <span class="token comment">// It will get related.</span>
      id<span class="token punctuation">:</span> <span class="token number">1253</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>You can disable updates, inserts, deletes etc. for the whole <a href="/objection.js/api/query-builder/mutate-methods.html#upsertgraph">upsertGraph</a> operation or for individual relations by using the <code>noUpdate</code>, <code>noInsert</code>, <code>noDelete</code> etc. options. See <a href="/objection.js/api/types/#type-upsertgraphoptions">UpsertGraphOptions</a> docs for more info.</p></div> <div class="page-edit"><!----> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/objection.js/guide/relations.html" class="prev">
          Relations
        </a></span> <span class="next"><a href="/objection.js/guide/transactions.html">
          Transactions
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/objection.js/assets/js/app.3297ac94.js" defer></script><script src="/objection.js/assets/js/27.5a15c74a.js" defer></script>
  </body>
</html>
