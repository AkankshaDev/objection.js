<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Transactions | Objection.js</title>
    <meta name="description" content="An SQL friendly ORM for node.js">
    
    
    <link rel="preload" href="/objection.js/assets/css/0.styles.9e48f2b0.css" as="style"><link rel="preload" href="/objection.js/assets/js/app.c0d22f08.js" as="script"><link rel="preload" href="/objection.js/assets/js/6.40162644.js" as="script"><link rel="preload" href="/objection.js/assets/js/31.00366c56.js" as="script"><link rel="prefetch" href="/objection.js/assets/js/1.b3507942.js"><link rel="prefetch" href="/objection.js/assets/js/10.3e982d5f.js"><link rel="prefetch" href="/objection.js/assets/js/11.a3ae54fe.js"><link rel="prefetch" href="/objection.js/assets/js/12.52f6cc78.js"><link rel="prefetch" href="/objection.js/assets/js/13.779c6359.js"><link rel="prefetch" href="/objection.js/assets/js/14.2dd4cb68.js"><link rel="prefetch" href="/objection.js/assets/js/15.79877066.js"><link rel="prefetch" href="/objection.js/assets/js/16.45e2a211.js"><link rel="prefetch" href="/objection.js/assets/js/17.0f3efc3c.js"><link rel="prefetch" href="/objection.js/assets/js/18.ecdda106.js"><link rel="prefetch" href="/objection.js/assets/js/19.f0fced61.js"><link rel="prefetch" href="/objection.js/assets/js/2.aa97c7d4.js"><link rel="prefetch" href="/objection.js/assets/js/20.937990b6.js"><link rel="prefetch" href="/objection.js/assets/js/21.9fbd43bf.js"><link rel="prefetch" href="/objection.js/assets/js/22.60ddfe19.js"><link rel="prefetch" href="/objection.js/assets/js/23.9b5b63b1.js"><link rel="prefetch" href="/objection.js/assets/js/24.d79fa801.js"><link rel="prefetch" href="/objection.js/assets/js/25.44df3623.js"><link rel="prefetch" href="/objection.js/assets/js/26.f06dfb7a.js"><link rel="prefetch" href="/objection.js/assets/js/27.95e0c57d.js"><link rel="prefetch" href="/objection.js/assets/js/28.d83a784b.js"><link rel="prefetch" href="/objection.js/assets/js/29.cc761722.js"><link rel="prefetch" href="/objection.js/assets/js/3.3ef9bd6b.js"><link rel="prefetch" href="/objection.js/assets/js/30.141fd9aa.js"><link rel="prefetch" href="/objection.js/assets/js/32.cb140799.js"><link rel="prefetch" href="/objection.js/assets/js/33.4e173aac.js"><link rel="prefetch" href="/objection.js/assets/js/34.1d0ad47a.js"><link rel="prefetch" href="/objection.js/assets/js/35.30e6f25f.js"><link rel="prefetch" href="/objection.js/assets/js/36.7c588122.js"><link rel="prefetch" href="/objection.js/assets/js/37.658a7820.js"><link rel="prefetch" href="/objection.js/assets/js/38.3033d13e.js"><link rel="prefetch" href="/objection.js/assets/js/39.deb9aa69.js"><link rel="prefetch" href="/objection.js/assets/js/40.f002b6df.js"><link rel="prefetch" href="/objection.js/assets/js/41.c965b68d.js"><link rel="prefetch" href="/objection.js/assets/js/42.7382c48c.js"><link rel="prefetch" href="/objection.js/assets/js/43.f0ab4c74.js"><link rel="prefetch" href="/objection.js/assets/js/44.9ce91832.js"><link rel="prefetch" href="/objection.js/assets/js/45.2377b850.js"><link rel="prefetch" href="/objection.js/assets/js/46.9eb2689f.js"><link rel="prefetch" href="/objection.js/assets/js/47.687bf782.js"><link rel="prefetch" href="/objection.js/assets/js/48.dde0902c.js"><link rel="prefetch" href="/objection.js/assets/js/49.667b3d2e.js"><link rel="prefetch" href="/objection.js/assets/js/50.982f7979.js"><link rel="prefetch" href="/objection.js/assets/js/51.7ffc7511.js"><link rel="prefetch" href="/objection.js/assets/js/52.b31a89eb.js"><link rel="prefetch" href="/objection.js/assets/js/53.41f9a335.js"><link rel="prefetch" href="/objection.js/assets/js/7.6663de3f.js"><link rel="prefetch" href="/objection.js/assets/js/8.52d314ab.js"><link rel="prefetch" href="/objection.js/assets/js/9.6b4ce4e2.js"><link rel="prefetch" href="/objection.js/assets/js/vendors~docsearch.3d458f8e.js">
    <link rel="stylesheet" href="/objection.js/assets/css/0.styles.9e48f2b0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/objection.js/" class="home-link router-link-active"><!----> <span class="site-name">Objection.js</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="/objection.js/guide/" class="nav-link router-link-active">Guide</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">API Reference</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/objection.js/api/objection/" class="nav-link">Main Module</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/query-builder/" class="nav-link">Query Builder</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/model/" class="nav-link">Model</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/types/" class="nav-link">Types</a></li></ul></div></div><div class="nav-item"><a href="/objection.js/recipes/" class="nav-link">Recipe Book</a></div><div class="nav-item"><a href="/objection.js/changelog/" class="nav-link">Changelog</a></div><div class="nav-item"><a href="https://github.com/vincit/objection.js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ⭐ Star
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/vincit/objection.js" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/objection.js/guide/" class="nav-link router-link-active">Guide</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">API Reference</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/objection.js/api/objection/" class="nav-link">Main Module</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/query-builder/" class="nav-link">Query Builder</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/model/" class="nav-link">Model</a></li><li class="dropdown-item"><!----> <a href="/objection.js/api/types/" class="nav-link">Types</a></li></ul></div></div><div class="nav-item"><a href="/objection.js/recipes/" class="nav-link">Recipe Book</a></div><div class="nav-item"><a href="/objection.js/changelog/" class="nav-link">Changelog</a></div><div class="nav-item"><a href="https://github.com/vincit/objection.js" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ⭐ Star
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/vincit/objection.js" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Guide</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/objection.js/guide/installation.html" class="sidebar-link">Installation</a></li><li><a href="/objection.js/guide/getting-started.html" class="sidebar-link">Getting started</a></li><li><a href="/objection.js/guide/models.html" class="sidebar-link">Models</a></li><li><a href="/objection.js/guide/relations.html" class="sidebar-link">Relations</a></li><li><a href="/objection.js/guide/query-examples.html" class="sidebar-link">Query examples</a></li><li><a href="/objection.js/guide/transactions.html" class="active sidebar-link">Transactions</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/objection.js/guide/transactions.html#creating-a-transaction" class="sidebar-link">Creating a transaction</a></li><li class="sidebar-sub-header"><a href="/objection.js/guide/transactions.html#using-a-transaction" class="sidebar-link">Using a transaction</a></li></ul></li><li><a href="/objection.js/guide/validation.html" class="sidebar-link">Validation</a></li><li><a href="/objection.js/guide/documents.html" class="sidebar-link">Documents</a></li><li><a href="/objection.js/guide/plugins.html" class="sidebar-link">Plugins</a></li><li><a href="/objection.js/guide/contributing.html" class="sidebar-link">Contribution guide</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="transactions"><a href="#transactions" aria-hidden="true" class="header-anchor">#</a> Transactions</h1> <p>Transactions are atomic and isolated units of work in relational databases. If you are not familiar with transactions, I suggest you read up on them. <a href="https://en.wikipedia.org/wiki/Database_transaction" target="_blank" rel="noopener noreferrer">The wikipedia article<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is a good place to start.</p> <h2 id="creating-a-transaction"><a href="#creating-a-transaction" aria-hidden="true" class="header-anchor">#</a> Creating a transaction</h2> <p>In objection, a transaction can be started by calling the <a href="/objection.js/api/objection/#transaction">objection.transaction</a> function:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> transaction <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'objection'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> returnValue <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">transaction</span><span class="token punctuation">(</span>Person<span class="token punctuation">.</span><span class="token function">knex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">trx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Here you can use the transaction.</span>

    <span class="token comment">// Whatever you return from the transaction callback gets returned</span>
    <span class="token comment">// from the `transaction` function.</span>
    <span class="token keyword">return</span> <span class="token string">'the return value of the transaction'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Here the transaction has been committed.</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Here the transaction has been rolled back.</span>
<span class="token punctuation">}</span>
</code></pre></div><p>You need to pass a knex instance as the first argument. If you don't have a knex instance otherwise available you can always access it through any <a href="/objection.js/api/model/">Model</a> using <a href="/objection.js/api/model/static-methods.html#static-knex">Model.knex()</a> provided that you have installed the knex instance globally using <a href="/objection.js/api/model/static-methods.html#static-knex">Model.knex(knex)</a> at some point.</p> <p>The second argument is a callback that gets called with the transaction object as an argument once the transaction has been successfully started. The transaction object is actually just a <a href="http://knexjs.org/#Transactions" target="_blank" rel="noopener noreferrer">knex transaction object<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and you can start the transaction just as well using <a href="http://knexjs.org/#Transactions" target="_blank" rel="noopener noreferrer">knex.transaction<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> function.</p> <p>The transaction is committed if the promise returned from the callback is resolved successfully. If the returned Promise is rejected or an error is thrown inside the callback the transaction is rolled back.</p> <p>An alternative way to start a transaction is to use the <code>objection.transaction.start</code> method:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> transaction <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'objection'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> trx<span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
  trx <span class="token operator">=</span> <span class="token keyword">await</span> transaction<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>Person<span class="token punctuation">.</span><span class="token function">knex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Here you can use the transaction.</span>

  <span class="token comment">// If you created the transaction using `transaction.start`, you need</span>
  <span class="token comment">// commit or rollback the transaction manually.</span>
  <span class="token keyword">await</span> trx<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> trx<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="using-a-transaction"><a href="#using-a-transaction" aria-hidden="true" class="header-anchor">#</a> Using a transaction</h2> <p>After you have created a transaction, you need to tell objection which queries should be executed inside that transaction. There are two ways to do that:</p> <ol><li><a href="/objection.js/guide/transactions.html#passing-around-a-transaction-object">By passing the transaction object to each query</a></li> <li><a href="/objection.js/guide/transactions.html#binding-models-to-a-transaction">By binding models to the transaction</a></li></ol> <h3 id="passing-around-a-transaction-object"><a href="#passing-around-a-transaction-object" aria-hidden="true" class="header-anchor">#</a> Passing around a transaction object</h3> <p>The most straight forwared way to use a transaction is to explicitly give it to each query you start. <a href="/objection.js/api/model/static-methods.html#static-query">query</a>, <a href="/objection.js/api/model/instance-methods.html#query">$query</a> and <a href="/objection.js/api/model/instance-methods.html#relatedquery">$relatedQuery</a> accept a transaction as their last argument.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> transaction <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'objection'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// You can access `knex` instance anywhere you want.</span>
<span class="token comment">// One way is to get it through any model.</span>
<span class="token keyword">const</span> knex <span class="token operator">=</span> Person<span class="token punctuation">.</span><span class="token function">knex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> scrappy <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">transaction</span><span class="token punctuation">(</span>knex<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">trx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> jennifer <span class="token operator">=</span> <span class="token keyword">await</span> Person
      <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>trx<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span>firstName<span class="token punctuation">:</span> <span class="token string">'Jennifer'</span><span class="token punctuation">,</span> lastName<span class="token punctuation">:</span> <span class="token string">'Lawrence'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> scrappy <span class="token operator">=</span> <span class="token keyword">await</span> jennifer
      <span class="token punctuation">.</span><span class="token function">$relatedQuery</span><span class="token punctuation">(</span><span class="token string">'pets'</span><span class="token punctuation">,</span> trx<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'Scrappy'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> scrappy<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Great success! Both Jennifer and Scrappy were inserted'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Something went wrong. Neither Jennifer nor Scrappy were inserted'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Note that you can pass either a normal knex instance or a transaction to <a href="/objection.js/api/model/static-methods.html#static-query">query</a>, <a href="/objection.js/api/model/instance-methods.html#relatedquery">$relatedQuery</a> etc. allowing you to build helper functions and services that can be used with or without a transaction. When a transaction is not wanted, just pass in the normal knex instance (or nothing at all if you have installed the knex object globally using <a href="/objection.js/api/model/static-methods.html#static-knex">Model.knex(knex)</a>):</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// `db` can be either a transaction or a knex instance or even</span>
<span class="token comment">// `null` or `undefined` if you have globally set the knex</span>
<span class="token comment">// instance using `Model.knex(knex)`.</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">insertPersonAndPet</span><span class="token punctuation">(</span><span class="token parameter">person<span class="token punctuation">,</span> pet<span class="token punctuation">,</span> db</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> person <span class="token operator">=</span> <span class="token keyword">await</span> Person
    <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>person<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> person
    <span class="token punctuation">.</span><span class="token function">$relatedQuery</span><span class="token punctuation">(</span><span class="token string">'pets'</span><span class="token punctuation">,</span> db<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>pet<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// All following four ways to call insertPersonAndPet work:</span>

<span class="token comment">// 1.</span>
<span class="token keyword">const</span> trx <span class="token operator">=</span> <span class="token keyword">await</span> transaction<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>Person<span class="token punctuation">.</span><span class="token function">knex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> <span class="token function">insertPersonAndPet</span><span class="token punctuation">(</span>person<span class="token punctuation">,</span> pet<span class="token punctuation">,</span> trx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> trx<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 2.</span>
<span class="token keyword">await</span> <span class="token function">transaction</span><span class="token punctuation">(</span>Person<span class="token punctuation">.</span><span class="token function">knex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">trx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">insertPersonAndPet</span><span class="token punctuation">(</span>person<span class="token punctuation">,</span> pet<span class="token punctuation">,</span> trx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 3.</span>
<span class="token keyword">await</span> <span class="token function">insertPersonAndPet</span><span class="token punctuation">(</span>person<span class="token punctuation">,</span> pet<span class="token punctuation">,</span> Person<span class="token punctuation">.</span><span class="token function">knex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 4.</span>
<span class="token keyword">await</span> <span class="token function">insertPersonAndPet</span><span class="token punctuation">(</span>person<span class="token punctuation">,</span> pet<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="binding-models-to-a-transaction"><a href="#binding-models-to-a-transaction" aria-hidden="true" class="header-anchor">#</a> Binding models to a transaction</h3> <p>The second way to use transactions avoids passing around a transaction object by &quot;binding&quot; model classes to a transaction. You pass all models you want to bind as arguments to the <a href="/objection.js/api/objection/#transaction">objection.transaction</a> method and as the last argument you provide a callback that receives <strong>copies</strong> of the models that have been bound to a newly started transaction. All queries started through the bound copies take part in the transaction and you don't need to pass around a transaction object. Note that the models passed to the callback are actual copies of the models passed as arguments to <a href="/objection.js/api/objection/#transaction">objection.transaction</a> and starting a query through any other object will <strong>not</strong> be executed inside a transaction.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> transaction <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'objection'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> scrappy <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">transaction</span><span class="token punctuation">(</span>Person<span class="token punctuation">,</span> Animal<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">Person<span class="token punctuation">,</span> Animal</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// Person and Animal inside this function are bound to a newly</span>
    <span class="token comment">// created transaction. The Person and Animal outside this function</span>
    <span class="token comment">// are not! Even if you do `require('./models/Person')` inside this</span>
    <span class="token comment">// function and start a query using the required `Person` it will</span>
    <span class="token comment">// NOT take part in the transaction. Only the actual objects passed</span>
    <span class="token comment">// to this function are bound to the transaction.</span>

    <span class="token keyword">await</span> Person
      <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span>firstName<span class="token punctuation">:</span> <span class="token string">'Jennifer'</span><span class="token punctuation">,</span> lastName<span class="token punctuation">:</span> <span class="token string">'Lawrence'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> Animal
      <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'Scrappy'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Something went wrong. Neither Jennifer nor Scrappy were inserted'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>You only need to give the <a href="/objection.js/api/objection/#transaction">objection.transaction</a> function the model classes you use explicitly. All the related model classes are implicitly bound to the same transaction:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> transaction <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'objection'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> scrappy <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">transaction</span><span class="token punctuation">(</span>Person<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">Person</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> jennifer <span class="token operator">=</span> <span class="token keyword">await</span> Person
      <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span>firstName<span class="token punctuation">:</span> <span class="token string">'Jennifer'</span><span class="token punctuation">,</span> lastName<span class="token punctuation">:</span> <span class="token string">'Lawrence'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// This creates a query using the `Animal` model class but we</span>
    <span class="token comment">// don't need to give `Animal` as one of the arguments to the</span>
    <span class="token comment">// transaction function because `jennifer` is an instance of</span>
    <span class="token comment">// the `Person` that is bound to a transaction.</span>
    <span class="token keyword">return</span> jennifer
      <span class="token punctuation">.</span><span class="token function">$relatedQuery</span><span class="token punctuation">(</span><span class="token string">'pets'</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'Scrappy'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Something went wrong. Neither Jennifer nor Scrappy were inserted'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The only way you can mess up with the transactions is if you <em>explicitly</em> start a query using a model class that is not bound to the transaction:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> transaction <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'objection'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Person <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./models/Person'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Animal <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./models/Animal'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">await</span> <span class="token function">transaction</span><span class="token punctuation">(</span>Person<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">BoundPerson</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// This will be executed inside the transaction.</span>
  <span class="token keyword">const</span> jennifer <span class="token operator">=</span> <span class="token keyword">await</span> BoundPerson
    <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span>firstName<span class="token punctuation">:</span> <span class="token string">'Jennifer'</span><span class="token punctuation">,</span> lastName<span class="token punctuation">:</span> <span class="token string">'Lawrence'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// OH NO! This query is executed outside the transaction</span>
  <span class="token comment">// since the `Animal` class is not bound to the transaction.</span>
  <span class="token keyword">await</span> Animal
    <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'Scrappy'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// OH NO! This query is executed outside the transaction</span>
  <span class="token comment">// since the `Person` class is not bound to the transaction.</span>
  <span class="token comment">// BoundPerson !== Person.</span>
  <span class="token keyword">await</span> Person
    <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span>firstName<span class="token punctuation">:</span> <span class="token string">'Bradley'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The transaction object is always passed as the last argument to the callback:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> transaction <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'objection'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">await</span> <span class="token function">transaction</span><span class="token punctuation">(</span>Person<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">Person<span class="token punctuation">,</span> trx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// `trx` is the knex transaction object.</span>
  <span class="token comment">// It can be passed to `transacting`, `query` etc.</span>
  <span class="token comment">// methods, or used as a knex query builder.</span>

  <span class="token keyword">const</span> jennifer <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">trx</span><span class="token punctuation">(</span><span class="token string">'persons'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span>firstName<span class="token punctuation">:</span> <span class="token string">'Jennifer'</span><span class="token punctuation">,</span> lastName<span class="token punctuation">:</span> <span class="token string">'Lawrence'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> scrappy <span class="token operator">=</span> <span class="token keyword">await</span> Animal<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>trx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'Scrappy'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> fluffy <span class="token operator">=</span> <span class="token keyword">await</span> Animal<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transacting</span><span class="token punctuation">(</span>trx<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'Fluffy'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    jennifer<span class="token punctuation">,</span>
    scrappy<span class="token punctuation">,</span>
    fluffy
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Originally we advertised this way of doing transactions as a remedy to the transaction passing plague but it has turned out to be pretty error-prone. This approach is handy for single inline functions that do a handful of operations, but becomes tricky when you have to call services and helper methods that also perform database queries. To get the helpers and service functions to participate in the transaction you need to pass around the bound copies of the model classes. If you <code>require</code> the same models in the helpers and start queries through them, they will <strong>not</strong> be executed in the transaction since the required models are not the bound copies, but the original models from which the copies were taken.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/objection.js/guide/query-examples.html" class="prev">Query examples</a></span> <span class="next"><a href="/objection.js/guide/validation.html">Validation</a>→
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/objection.js/assets/js/app.c0d22f08.js" defer></script><script src="/objection.js/assets/js/6.40162644.js" defer></script><script src="/objection.js/assets/js/31.00366c56.js" defer></script>
  </body>
</html>
